<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Top Up - </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }

        .selected-package {
            border-color: #3b82f6;
            background-color: #dbeafe;
            --tw-ring-color: #3b82f6;
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width)
                var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width))
                var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }

        .dark .selected-package {
            background-color: #1e3a8a;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <header class="bg-white dark:bg-gray-800 shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">MyGame TopUp</h1>
            <a href="./index.html" class="text-blue-600 dark:text-blue-400 hover:underline"> &larr; Back to Game Selection</a>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 max-w-4xl mx-auto">
            <div class="flex flex-col md:flex-row gap-8 mb-8">
                <img id="game-image" src="https://placehold.co/300x400/cccccc/ffffff?text=Loading..." alt="Game Logo"
                    class="w-full md:w-1/3 rounded-lg object-cover" />
                <div class="flex-1">
                    <h2 id="game-name" class="text-4xl font-bold mb-4">Loading Game Name...</h2>
                    <p class="text-gray-600 dark:text-gray-400">Please select the package you want to top up and
                        enter the correct player information.</p>
                </div>
            </div>

            <div>
                <div class="mb-6">
                    <label for="player-id" class="block text-xl font-medium mb-2">1. Enter Player ID</label>
                    <input type="text" id="player-id" name="player-id"
                        class="w-full md:w-1/2 p-3 bg-gray-200 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter Player ID" />
                </div>

                <div>
                    <h3 class="text-xl font-medium mb-4">2. Choose a Package</h3>
                    <div id="package-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        <div class="package-item p-4 border rounded-lg text-center cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 transition"
                            data-name="100 Diamonds" data-price="1.43">
                            <p class="font-bold text-lg">100 Diamonds</p>
                            <p class="text-gray-500">$1.43 USD</p>
                        </div>
                        <div class="package-item p-4 border rounded-lg text-center cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 transition"
                            data-name="220 Diamonds" data-price="2.86">
                            <p class="font-bold text-lg">220 Diamonds</p>
                            <p class="text-gray-500">$2.86 USD</p>
                        </div>
                        <div class="package-item p-4 border rounded-lg text-center cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 transition"
                            data-name="500 Diamonds" data-price="5.71">
                            <p class="font-bold text-lg">500 Diamonds</p>
                            <p class="text-gray-500">$5.71 USD</p>
                        </div>
                        <div class="package-item p-4 border rounded-lg text-center cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 transition"
                            data-name="1,200 Diamonds" data-price="14.29">
                            <p class="font-bold text-lg">1,200 Diamonds</p>
                            <p class="text-gray-500">$14.29 USD</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button id="checkout-button"
                        class="bg-green-500 hover:bg-green-600 text-white font-bold text-xl py-4 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">Proceed to Payment</button>
                </div>
            </div>
        </div>
    </main>

    <div id="confirmation-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div
            class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 md:p-8 w-full max-w-md text-center">
            <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
            <p id="modal-body" class="mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="modal-close-button"
                    class="px-6 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg hover:bg-gray-400">Close</button>
                <button id="modal-confirm-button"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAkXOGTHHHn9HOFpCypGhbVEi9IDRW6hfw",
            authDomain: "mygame-topup-shop.firebaseapp.com",
            projectId: "mygame-topup-shop",
            storageBucket: "mygame-topup-shop.firebasestorage.app",
            messagingSenderId: "878663003843",
            appId: "1:878663003843:web:38c5b8cc8a030f01ab3c76"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('gameId');
        const gameName = urlParams.get('gameName');
        const imageUrl = urlParams.get('imageUrl');

        if (gameName && imageUrl) {
            document.title = `Top Up - ${gameName}`;
            document.getElementById('game-name').textContent = gameName;
            document.getElementById('game-image').src = imageUrl;
            document.getElementById('game-image').alt = `Logo of ${gameName}`;
        } else {
            document.getElementById('game-name').textContent = 'Game data not found';
        }

        const packageItems = document.querySelectorAll('.package-item');
        const playerIdInput = document.getElementById('player-id');
        const checkoutButton = document.getElementById('checkout-button');
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalConfirmButton = document.getElementById('modal-confirm-button');

        let selectedPackage = null;

        packageItems.forEach(item => {
            item.addEventListener('click', () => {
                packageItems.forEach(p => p.classList.remove('selected-package'));
                item.classList.add('selected-package');
                selectedPackage = { name: item.dataset.name, price: item.dataset.price };
            });
        });

        checkoutButton.addEventListener('click', () => {
            if (!playerIdInput.value) {
                showModal('Error', 'Please enter your Player ID', true);
                return;
            }
            if (!selectedPackage) {
                showModal('Error', 'Please select a package to top up', true);
                return;
            }
            const confirmationMessage = `You are about to top up '${selectedPackage.name}' for $${selectedPackage.price} USD to Player ID: ${playerIdInput.value}`;
            showModal('Order Confirmation', confirmationMessage);
        });

        function showModal(title, body, isError = false) {
            modalTitle.textContent = title;
            modalBody.textContent = body;
            modal.classList.remove('hidden');
            modalConfirmButton.classList.toggle('hidden', isError);
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        modalCloseButton.addEventListener('click', closeModal);

        modalConfirmButton.addEventListener('click', async () => {
            modalConfirmButton.disabled = true;
            modalConfirmButton.textContent = 'Saving...';

            const orderData = {
                gameId: gameId,
                gameName: gameName,
                playerId: playerIdInput.value,
                packageName: selectedPackage.name,
                price: Number(selectedPackage.price),
                status: 'pending',
                createdAt: serverTimestamp()
            };

            try {
                const docRef = await addDoc(collection(db, "orders"), orderData);
                window.location.href = `./success.html?orderId=${docRef.id}`;
            } catch (error) {
                console.error("Error adding document: ", error);
                showModal('Error', 'Failed to save your order. Please try again.', true);
                modalConfirmButton.disabled = false;
                modalConfirmButton.textContent = 'Confirm';
            }
        });
    </script>
</body>

</html>
